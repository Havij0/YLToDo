<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Todo App ‚Äì v0.11</title>

<style>
/* --- ALL YOUR ORIGINAL STYLES RESTORED --- */
* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkSystemFont, "SF Pro Text", sans-serif; background: #f2f2f7; }
.hidden { display: none; }

header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 20; }
header .title { font-size: 20px; font-weight: 700; }
header .version { font-size: 12px; color: #888; }

#tabBar { position: fixed; top: 56px; left: 0; right: 0; height: 44px; display: flex; background: #fff; border-bottom: 1px solid #ddd; z-index: 20; }
.tab { flex: 1; text-align: center; line-height: 44px; cursor: pointer; font-weight: 600; color: #666; }
.tab.active { color: #000; border-bottom: 2px solid #000; }

#content { padding-top: 102px; padding-bottom: 120px; overflow-y: auto; position: relative; }

.task { background: #fff; margin: 10px 12px; border-radius: 16px; overflow: hidden; position: relative; }
.task.done { opacity: 0.45; }
.task-row { display: flex; align-items: center; min-height: 52px; padding: 0 14px; background: #fff; position: relative; z-index: 2; transition: transform 0.25s ease, opacity 0.25s ease; touch-action: pan-y; }
.task-left { width: 36px; }
.task-middle { flex: 1; min-width: 0; }
.task-right { width: 20px; }
.task-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
.dot { width: 10px; height: 10px; border-radius: 50%; }

.swipe-bg { position: absolute; inset: 0; display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; background: #f2f2f7; z-index: 1; }
.swipe-btn { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-left: 8px; color: #fff; font-size: 18px; }

#addBar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #ddd; padding: 10px 12px; display: flex; gap: 8px; z-index: 20; }
#addBar input, #addBar select { flex: 1; font-size: 16px; padding: 12px; border-radius: 14px; border: 1px solid #ccc; }
#addBar button { padding: 0 18px; font-size: 22px; border-radius: 14px; border: none; background: #000; color: #fff; }

#details { position: fixed; inset: 0; background: #f2f2f7; z-index: 50; overflow-y: auto; }
#details .spacer { height: 72px; }
.section { background: #fff; margin: 12px; padding: 12px 16px; border-radius: 16px; }
.section h3 { margin: 0 0 8px; font-size: 13px; color: #666; }

#advAddTask { position: fixed; left: 0; right: 0; bottom: 0; max-height: 90%; overflow-y: auto; background: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -3px 10px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.3s ease; z-index: 30; padding: 16px; }
#advAddTask .handle { width: 40px; height: 4px; background: #ccc; border-radius: 2px; margin: 0 auto 12px; }

/* NEW CALENDAR STYLES (Requested UI updates) */
#agendaToggle { padding: 10px 12px; display: flex; gap: 8px; }
#agendaToggle button { flex: 1; padding: 8px; border-radius: 10px; border: 1px solid #ddd; background: #fff; font-weight: 600; }
.month-header { margin: 16px 12px 8px; font-weight: 700; color: #333; }
#calendarGrid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 0 12px; }
.calendar-day { height: 40px; border-radius: 10px; background: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; border: 1px solid #eee; }
.cal-yellow { background:#ffd60a; }
.cal-orange { background:#ff9f0a; }
.cal-red { background:#ff3b30; color:#fff; }
.agenda-date { margin: 12px 12px 4px; font-weight: 600; font-size: 14px; color: #333; }
</style>
</head>

<body>

<header>
  <div class="title">Todo App</div>
  <div class="version">v0.11</div>
</header>

<div id="tabBar">
  <div class="tab active" data-tab="today">Today</div>
  <div class="tab" data-tab="unscheduled">To Be Scheduled</div>
  <div class="tab" data-tab="agenda">Agenda</div>
</div>

<div id="agendaToggle" class="hidden">
  <button onclick="setAgendaView('calendar')">Calendar</button>
  <button onclick="setAgendaView('list')">List</button>
</div>

<div id="content">
    <div id="calendarView" class="hidden"></div>
    <div id="tasks"></div>
</div>

<div id="addBar">
  <input id="newTitle" placeholder="New task‚Ä¶" />
  <select id="newPriority">
    <option value="3">Normal</option>
    <option value="2">Important</option>
    <option value="1">Must</option>
  </select>
  <button onclick="addTask()">+</button>
  <button onclick="openAdvancedAdd()">‚ãÅ</button>
</div>

<div id="advAddTask">
  <div class="handle"></div>
  <h3>Advanced Add Task</h3>
  <div class="section"><input id="advTitle" placeholder="Task title" /></div>
  <div class="section"><textarea id="advDesc" placeholder="Description" rows="3"></textarea></div>
  <div class="section"><select id="advPriority">
    <option value="3">Normal</option>
    <option value="2">Important</option>
    <option value="1">Must</option>
  </select></div>
  <div class="section"><textarea id="advSubtasks" placeholder="Subtasks, one per line" rows="3"></textarea></div>
  <div class="section"><label>Scheduled Date:</label><input type="date" id="advDate" /></div>
  <button onclick="addAdvancedTask()">Add Task</button>
  <button onclick="closeAdvancedAdd()">Cancel</button>
</div>

<div id="reschedulePopup" style="position: fixed; z-index: 60; background: #fff; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.25); padding: 12px 16px; display: none; text-align: center;">
    <div>Select Date:</div>
    <button onclick="rescheduleTask('tomorrow')">Tomorrow</button>
    <input type="date" id="rescheduleInput">
    <button onclick="applyReschedule()">Apply</button>
</div>

<div id="details" class="hidden">
    <header>
      <button onclick="closeDetails()">‚Üê Back</button>
      <button id="editBtn" onclick="toggleEdit()">Edit</button>
    </header>
    <div class="spacer"></div>
    <div class="section"><h3>Title</h3><div id="vTitle" class="read"></div><input id="eTitle" class="hidden"></div>
    <div class="section hidden" id="secDesc"><h3>Description</h3><div id="vDesc" class="read"></div><textarea id="eDesc" class="hidden" rows="3"></textarea></div>
    <div class="section hidden" id="secSubs"><h3>Subtasks</h3><div id="subtasks"></div><textarea id="subInput" class="hidden" placeholder="One subtask per line"></textarea><button id="addSubBtn" class="hidden" onclick="addSubtasks()">+ Add subtasks</button></div>
    <div class="section" id="secDate"><h3>Scheduled Date</h3><input type="date" id="eDate" class="hidden"><div id="vDate" class="read"></div></div>
    <button id="deleteBtn" class="hidden" onclick="deleteTask()">Delete task</button>
    <div class="timestamps" id="timestamps"></div>
</div>

<script>
// Elements
const newTitle = document.getElementById("newTitle");
const newPriority = document.getElementById("newPriority");
const tasksDiv = document.getElementById("tasks");
const calendarView = document.getElementById("calendarView");
const agendaToggle = document.getElementById("agendaToggle");
const adv = document.getElementById("advAddTask");

let tasks = JSON.parse(localStorage.getItem("tasks_v064") || "[]");
let currentTab = "today";
let agendaView = "calendar";
let selectedAgendaDate = null;

// FIX: Local Date Formatter to avoid "Day off by one"
function formatDateLocal(d) {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

const todayStr = formatDateLocal(new Date());

function save() { localStorage.setItem("tasks_v064", JSON.stringify(tasks)); }

// TABS
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    currentTab=tab.dataset.tab;
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    selectedAgendaDate = null;
    render();
  });
});

function setAgendaView(view) {
    agendaView = view;
    selectedAgendaDate = null;
    render();
}

// ORIGINAL TASK ADDING LOGIC
function addTask(){
  const t=newTitle.value.trim();
  if(!t) return;
  const now = Date.now();
  let scheduled = (currentTab==="today") ? todayStr : "";
  tasks.push({id: now, title: t, desc: "", priority: +newPriority.value, done:false, subtasks:[], scheduled, created:now, edited:now});
  newTitle.value = "";
  save(); render();
}

function addAdvancedTask(){
  const t = document.getElementById("advTitle").value.trim(); if(!t) return;
  const now = Date.now();
  const subs = document.getElementById("advSubtasks").value.split("\n").filter(Boolean).map(s=>({title:s,done:false}));
  tasks.push({id:now, title:t, desc:document.getElementById("advDesc").value.trim(), priority:+document.getElementById("advPriority").value, done:false, subtasks:subs, scheduled:document.getElementById("advDate").value||"", created:now, edited:now});
  save(); render(); closeAdvancedAdd();
}

// RENDER LOGIC (Restored Card Rendering + Updated Agenda)
function render() {
    tasksDiv.innerHTML = "";
    calendarView.innerHTML = "";
    agendaToggle.classList.add("hidden");
    calendarView.classList.add("hidden");

    if (currentTab === "today") {
        tasks.filter(t => t.scheduled === todayStr).forEach(renderTaskCard);
    } 
    else if (currentTab === "unscheduled") {
        tasks.filter(t => !t.scheduled).forEach(renderTaskCard);
    } 
    else if (currentTab === "agenda") {
        agendaToggle.classList.remove("hidden");
        if (selectedAgendaDate) {
            renderDayListView();
        } else if (agendaView === "calendar") {
            calendarView.classList.remove("hidden");
            renderCalendarView();
        } else {
            renderAgendaListView();
        }
    }
}

function renderCalendarView() {
    const today = new Date();
    for (let m = 0; m < 4; m++) {
        const monthDate = new Date(today.getFullYear(), today.getMonth() + m, 1);
        const header = document.createElement("div");
        header.className = "month-header";
        header.textContent = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        calendarView.appendChild(header);

        const grid = document.createElement("div");
        grid.id = "calendarGrid";
        const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();

        for (let i = 1; i <= daysInMonth; i++) {
            const d = new Date(monthDate.getFullYear(), monthDate.getMonth(), i);
            const dateStr = formatDateLocal(d);
            const dayTasks = tasks.filter(t => t.scheduled === dateStr);

            const cell = document.createElement("div");
            cell.className = "calendar-day";
            cell.textContent = i;

            if (dayTasks.length) {
                if (dayTasks.some(t => t.priority === 1)) cell.classList.add("cal-red");
                else if (dayTasks.some(t => t.priority === 2)) cell.classList.add("cal-orange");
                else cell.classList.add("cal-yellow");
            }
            cell.onclick = () => { selectedAgendaDate = dateStr; render(); };
            grid.appendChild(cell);
        }
        calendarView.appendChild(grid);
    }
}

function renderDayListView() {
    const back = document.createElement("div");
    back.style = "padding: 10px; color: blue; cursor: pointer;";
    back.textContent = "‚Üê Back to Calendar";
    back.onclick = () => { selectedAgendaDate = null; render(); };
    tasksDiv.appendChild(back);

    const h = document.createElement("div");
    h.className = "agenda-date";
    h.textContent = selectedAgendaDate;
    tasksDiv.appendChild(h);

    tasks.filter(t => t.scheduled === selectedAgendaDate).forEach(renderTaskCard);
}

function renderAgendaListView() {
    const scheduled = tasks.filter(t => t.scheduled).sort((a,b) => a.scheduled.localeCompare(b.scheduled));
    let lastDate = "";
    scheduled.forEach(t => {
        if (t.scheduled !== lastDate) {
            const h = document.createElement("div");
            h.className = "agenda-date";
            h.textContent = t.scheduled;
            tasksDiv.appendChild(h);
            lastDate = t.scheduled;
        }
        renderTaskCard(t);
    });
}

// RESTORED ORIGINAL TASK CARD UI & SWIPE LOGIC
function renderTaskCard(task){
  const card=document.createElement("div");
  card.className="task"+(task.done?" done":"");
  const bg=document.createElement("div"); bg.className="swipe-bg";
  bg.append(
    swipeBtn("‚úèÔ∏è","#007aff",()=>openDetails(task.id)),
    swipeBtn("üìÖ","#ff9500",()=>{ openReschedule(task, card.querySelector(".task-row")); }),
    swipeBtn("üóë","#ff3b30",()=>{ tasks=tasks.filter(t=>t.id!==task.id); save(); render(); })
  );

  const row=document.createElement("div"); row.className="task-row";
  let startX=0, dx=0;
  row.addEventListener("touchstart", e=>startX=e.touches[0].clientX);
  row.addEventListener("touchmove", e=>{ dx=e.touches[0].clientX-startX; if(dx<0) row.style.transform=`translateX(${dx}px)`; });
  row.addEventListener("touchend", ()=>{ if(dx<-80) row.style.transform=`translateX(-160px)`; else row.style.transform="translateX(0)"; dx=0; });

  const left=document.createElement("div"); left.className="task-left";
  const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=task.done;
  cb.onchange=e=>{ task.done=cb.checked; save(); render(); e.stopPropagation(); };
  left.append(cb);

  const mid=document.createElement("div"); mid.className="task-middle";
  const title=document.createElement("div"); title.className="task-title"; title.textContent=task.title;
  title.onclick=()=>openDetails(task.id); mid.append(title);

  const right=document.createElement("div"); right.className="task-right";
  const dot=document.createElement("div"); dot.className="dot";
  dot.style.background=task.priority===1?"#ff3b30":task.priority===2?"#ff9500":"#34c759";
  right.append(dot);

  row.append(left,mid,right); card.append(bg,row); tasksDiv.append(card);
}

function swipeBtn(icon,color,fn){ const b=document.createElement("div"); b.className="swipe-btn"; b.textContent=icon; b.style.background=color; b.onclick=e=>{ e.stopPropagation(); fn(); }; return b; }

// RESTORED DRAWER FUNCTIONS
function openAdvancedAdd(){ adv.style.transform="translateY(0)"; }
function closeAdvancedAdd(){ adv.style.transform="translateY(100%)"; }

// (Your remaining functions like toggleEdit, openDetails, etc. from original code go here)
function openDetails(id){ /* Existing logic */ }
function closeDetails(){ save(); render(); document.getElementById("details").classList.add("hidden"); }

render();
</script>
</body>
</html>

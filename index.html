<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Todo App ‚Äì v0.10</title>

<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkSystemFont, "SF Pro Text", sans-serif; background: #f2f2f7; }
.hidden { display: none; }

/* HEADER */
header {
  position: fixed; top: 0; left: 0; right: 0;
  height: 56px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px;
  z-index: 20;
}
header .title { font-size: 20px; font-weight: 700; }
header .version { font-size: 12px; color: #888; }

/* TAB BAR */
#tabBar {
  position: fixed; top: 56px; left: 0; right: 0;
  height: 44px;
  display: flex;
  background: #fff;
  border-bottom: 1px solid #ddd;
  z-index: 20;
}
.tab {
  flex: 1;
  text-align: center;
  line-height: 44px;
  cursor: pointer;
  font-weight: 600;
  color: #666;
}
.tab.active { color: #000; border-bottom: 2px solid #000; }

/* CONTENT */
#content { padding-top: 102px; padding-bottom: 120px; overflow-y: auto; position: relative; }

/* TASK */
.task { background: #fff; margin: 10px 12px; border-radius: 16px; overflow: hidden; position: relative; }
.task.done { opacity: 0.45; }
.task-row { display: flex; align-items: center; min-height: 52px; padding: 0 14px; background: #fff; position: relative; z-index: 2; transition: transform 0.25s ease, opacity 0.25s ease; touch-action: pan-y; }
.task-left { width: 36px; }
.task-middle { flex: 1; min-width: 0; }
.task-right { width: 20px; }
.task-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
.dot { width: 10px; height: 10px; border-radius: 50%; }

/* SWIPE */
.swipe-bg { position: absolute; inset: 0; display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; background: #f2f2f7; z-index: 1; }
.swipe-btn { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-left: 8px; color: #fff; font-size: 18px; }

/* ADD BAR */
#addBar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #ddd; padding: 10px 12px; display: flex; gap: 8px; z-index: 20; }
#addBar input, #addBar select { flex: 1; font-size: 16px; padding: 12px; border-radius: 14px; border: 1px solid #ccc; }
#addBar button { padding: 0 18px; font-size: 22px; border-radius: 14px; border: none; background: #000; color: #fff; }

/* DETAILS */
#details { position: fixed; inset: 0; background: #f2f2f7; z-index: 50; overflow-y: auto; }
#details .spacer { height: 72px; }
.section { background: #fff; margin: 12px; padding: 12px 16px; border-radius: 16px; }
.section h3 { margin: 0 0 8px; font-size: 13px; color: #666; }
.read { font-size: 16px; }
input, textarea, select { width: 100%; font-size: 16px; padding: 10px; border-radius: 12px; border: 1px solid #ccc; }
input[type="date"] { height: 40px; padding: 8px; }
textarea { resize: none; }

/* SUBTASK */
.subtask { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.subtask input { width: 20px; height: 20px; }
.subtask .text { flex: 1; }
#deleteBtn { margin: 16px 12px; padding: 14px; font-size: 16px; border-radius: 16px; background: #ff3b30; color: #fff; border: none; }
.timestamps { margin: 0 12px 24px; font-size: 12px; color: #888; }

/* ADVANCED ADD TASK PULL-UP */
#advAddTask {
  position: fixed; left: 0; right: 0; bottom: 0;
  max-height: 90%; overflow-y: auto; background: #fff;
  border-top-left-radius: 20px; border-top-right-radius: 20px;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.15);
  transform: translateY(100%); transition: transform 0.3s ease; z-index: 30; padding: 16px; touch-action: none;
}
#advAddTask .handle { width: 40px; height: 4px; background: #ccc; border-radius: 2px; margin: 0 auto 12px; }

/* AGENDA DATE HEADER */
.agenda-date { margin: 12px 12px 4px; font-weight: 600; font-size: 14px; color: #333; }

/* SCHEDULE SELECTOR */
#reschedulePopup {
  position: fixed; z-index: 60; background: #fff; border-radius: 16px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.25);
  padding: 12px 16px; display: none; text-align: center;
}
#reschedulePopup button { margin: 4px; padding: 6px 12px; border-radius: 12px; border: 1px solid #ccc; background: #eee; cursor: pointer; }

/* CALENDAR */
#calendarView {
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}
.calendar-day {
  height: 44px;
  border-radius: 12px;
  background: #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  cursor: pointer;
}
.cal-yellow { background:#ffd60a; }
.cal-orange { background:#ff9f0a; }
.cal-red { background:#ff3b30; color:#fff; }

</style>
</head>

<body>

<header>
  <div class="title">Todo App</div>
  <div class="version">v0.10</div>
</header>

<div id="tabBar">
  <div class="tab active" data-tab="today">Today</div>
  <div class="tab" data-tab="unscheduled">To Be Scheduled</div>
  <div class="tab" data-tab="agenda">Agenda</div>
</div>
<!-- AGENDA VIEW TOGGLE -->
<div id="agendaToggle" style="display:none; padding:8px 12px;">
  <button onclick="setAgendaView('calendar')">Calendar</button>
  <button onclick="setAgendaView('list')">List</button>
</div>

<!-- CALENDAR CONTAINER -->
<div id="calendarView" class="hidden"></div>

<div id="content"><div id="tasks"></div></div>

<div id="addBar">
  <input id="newTitle" placeholder="New task‚Ä¶" />
  <select id="newPriority">
    <option value="3">Normal</option>
    <option value="2">Important</option>
    <option value="1">Must</option>
  </select>
  <button onclick="addTask()">+</button>
  <button onclick="openAdvancedAdd()">‚ãÅ</button>
</div>

<!-- ADVANCED ADD TASK -->
<div id="advAddTask">
  <div class="handle"></div>
  <h3>Advanced Add Task</h3>
  <div class="section"><input id="advTitle" placeholder="Task title" /></div>
  <div class="section"><textarea id="advDesc" placeholder="Description" rows="3"></textarea></div>
  <div class="section"><select id="advPriority">
    <option value="3">Normal</option>
    <option value="2">Important</option>
    <option value="1">Must</option>
  </select></div>
  <div class="section"><textarea id="advSubtasks" placeholder="Subtasks, one per line" rows="3"></textarea></div>
  <div class="section"><label>Scheduled Date:</label><input type="date" id="advDate" /></div>
  <button onclick="addAdvancedTask()">Add Task</button>
  <button onclick="closeAdvancedAdd()">Cancel</button>
</div>

<!-- RESCHEDULE POPUP -->
<div id="reschedulePopup">
  <div>Select Date:</div>
  <button onclick="rescheduleTask('tomorrow')">Tomorrow</button>
  <input type="date" id="rescheduleInput">
  <button onclick="applyReschedule()">Apply</button>
</div>

<!-- DETAILS -->
<div id="details" class="hidden">
  <header>
    <button onclick="closeDetails()">‚Üê Back</button>
    <button id="editBtn" onclick="toggleEdit()">Edit</button>
  </header>
  <div class="spacer"></div>
  <div class="section"><h3>Title</h3><div id="vTitle" class="read"></div><input id="eTitle" class="hidden"></div>
  <div class="section hidden" id="secDesc"><h3>Description</h3><div id="vDesc" class="read"></div><textarea id="eDesc" class="hidden" rows="3"></textarea></div>
  <div class="section hidden" id="secSubs"><h3>Subtasks</h3><div id="subtasks"></div><textarea id="subInput" class="hidden" placeholder="One subtask per line"></textarea><button id="addSubBtn" class="hidden" onclick="addSubtasks()">+ Add subtasks</button></div>
  <div class="section" id="secDate"><h3>Scheduled Date</h3><input type="date" id="eDate" class="hidden"><div id="vDate" class="read"></div></div>
  <button id="deleteBtn" class="hidden" onclick="deleteTask()">Delete task</button>
  <div class="timestamps" id="timestamps"></div>
</div>

<script>
// Elements
const newTitle = document.getElementById("newTitle");
const newPriority = document.getElementById("newPriority");
const tasksDiv = document.getElementById("tasks");
const adv = document.getElementById("advAddTask");
const advTitle = document.getElementById("advTitle");
const advDesc = document.getElementById("advDesc");
const advPriority = document.getElementById("advPriority");
const advSubtasks = document.getElementById("advSubtasks");
const advDate = document.getElementById("advDate");
const tabs = document.querySelectorAll(".tab");
const addBar = document.getElementById("addBar");
const detailsView = document.getElementById("details");
const resPopup = document.getElementById("reschedulePopup");
const resInput = document.getElementById("rescheduleInput");

let tasks = JSON.parse(localStorage.getItem("tasks_v064") || "[]");
let active = null;
let editMode = false;
let currentTab = "today";
const SWIPE_WIDTH = 160;
const todayStr = new Date().toISOString().slice(0,10);
advDate.value = "";

let agendaView = "calendar";
let selectedAgendaDate = null;

const calendarView = document.getElementById("calendarView");
const agendaToggle = document.getElementById("agendaToggle");
/* ===============================
   ADD BAR : SWIPE UP TO OPEN ADVANCED ADD
   =============================== */
let addStartY = 0;
let addDragging = false;

addBar.addEventListener("touchstart", e => {
  addStartY = e.touches[0].clientY;
  addDragging = true;
});

addBar.addEventListener("touchmove", e => {
  if (!addDragging) return;
  const dy = addStartY - e.touches[0].clientY;

  // Swipe up threshold
  if (dy > 60) {
    openAdvancedAdd();
    addDragging = false;
  }
});

addBar.addEventListener("touchend", () => {
  addDragging = false;
});

// ===============================
// TAB SWITCH
// ===============================
tabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    currentTab=tab.dataset.tab;
    tabs.forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    render();
  });
});

// ===============================
// SAVE
// ===============================
function save(){ localStorage.setItem("tasks_v064", JSON.stringify(tasks)); }

// ===============================
// QUICK ADD
// ===============================
function addTask(){
  const t=newTitle.value.trim();
  if(!t) return;
  const now = Date.now();
  let scheduled = "";
  if(currentTab==="today") scheduled = todayStr; 
  tasks.push({id: now, title: t, desc: "", priority: +newPriority.value, done:false, subtasks:[], scheduled, created:now, edited:now});
  newTitle.value = "";
  save(); render();
}

// ===============================
// ADVANCED ADD
// ===============================
function addAdvancedTask(){
  const t = advTitle.value.trim(); if(!t) return;
  const now = Date.now();
  const subs = advSubtasks.value.split("\n").filter(Boolean).map(s=>({title:s,done:false}));
  tasks.push({id:now, title:t, desc:advDesc.value.trim(), priority:+advPriority.value, done:false, subtasks:subs, scheduled:advDate.value||"", created:now, edited:now});
  advTitle.value=""; advDesc.value=""; advSubtasks.value=""; advPriority.value=3; advDate.value="";
  save(); render(); closeAdvancedAdd();
}

// ===============================
// SWIPE BUTTON HELPER
// ===============================
function swipeBtn(icon,color,fn){ const b=document.createElement("div"); b.className="swipe-btn"; b.textContent=icon; b.style.background=color; b.onclick=e=>{ e.stopPropagation(); fn(); }; return b; }

// ===============================
// RESCHEDULE
// ===============================
let currentResTask = null;
function openReschedule(task, row){
  currentResTask = task;
  resPopup.style.display="block";
  const rect = row.getBoundingClientRect();
  resPopup.style.top = (rect.top + rect.height/2 - 50) + "px";
  resPopup.style.left = (window.innerWidth/2 - 80) + "px";
}
function rescheduleTask(option){
  if(option==="tomorrow"){
    const d = new Date();
    d.setDate(d.getDate()+1);
    currentResTask.scheduled = d.toISOString().slice(0,10);
  }
  save(); render(); hideResPopup();
}
function applyReschedule(){
  if(!currentResTask) return;

  // If no date selected ‚Üí move to "To Be Scheduled"
  currentResTask.scheduled = resInput.value || "";

  save();
  render();
  hideResPopup();
}
function hideResPopup(){ resPopup.style.display="none"; currentResTask=null; }
document.addEventListener("click", e=>{ if(!resPopup.contains(e.target)) hideResPopup(); });

// ===============================
// RENDER TASKS
// ===============================
function render(){
  tasksDiv.innerHTML = "";
  calendarView.innerHTML = "";

  if(currentTab !== "agenda"){
    agendaToggle.style.display = "none";
    calendarView.classList.add("hidden");
  }

  if(currentTab === "agenda"){
    agendaToggle.style.display = "block";

    if(agendaView === "calendar"){
      calendarView.classList.remove("hidden");
      renderCalendar();
      return;
    }

    // LIST VIEW
    calendarView.classList.add("hidden");
    renderAgendaList();
    return;
  }

  // TODAY / UNSCHEDULED
  tasks
    .filter(t => currentTab==="today"
      ? t.scheduled === todayStr
      : !t.scheduled)
    .forEach(renderTaskCard);
}
function renderCalendar(){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();

  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);

  for(let i=1; i<=last.getDate(); i++){
    const dateStr = new Date(year, month, i).toISOString().slice(0,10);
    const dayTasks = tasks.filter(t => t.scheduled === dateStr);

    const cell = document.createElement("div");
    cell.className = "calendar-day";
    cell.textContent = i;

    if(dayTasks.length){
      const hasMust = dayTasks.some(t=>t.priority===1);
      const hasImp = dayTasks.some(t=>t.priority===2);

      if(hasMust) cell.classList.add("cal-red");
      else if(hasImp) cell.classList.add("cal-orange");
      else cell.classList.add("cal-yellow");
    }

    cell.onclick = ()=>{
      selectedAgendaDate = dateStr;
      agendaView = "list";
      render();
    };

    calendarView.append(cell);
  }
}
function renderAgendaList(){
  const list = selectedAgendaDate
    ? tasks.filter(t=>t.scheduled===selectedAgendaDate)
    : tasks.filter(t=>t.scheduled);

  if(selectedAgendaDate){
    const h = document.createElement("div");
    h.className="agenda-date";
    h.textContent = selectedAgendaDate;
    tasksDiv.append(h);
  }

  list.forEach(renderTaskCard);
}

function renderTaskCard(task){
  const card=document.createElement("div");
  card.className="task"+(task.done?" done":"");
  const bg=document.createElement("div"); bg.className="swipe-bg";
  bg.append(
    swipeBtn("‚úèÔ∏è","#007aff",()=>openDetails(task.id)),
    swipeBtn("üìÖ","#ff9500",()=>{
      const row = card.querySelector(".task-row");
      openReschedule(task,row);
    }),
    swipeBtn("üóë","#ff3b30",()=>{ tasks=tasks.filter(t=>t.id!==task.id); save(); render(); })
  );

  const row=document.createElement("div"); row.className="task-row";
  let startX=0, dx=0;
  row.addEventListener("touchstart", e=>startX=e.touches[0].clientX);
  row.addEventListener("touchmove", e=>{ dx=e.touches[0].clientX-startX; if(dx<0) row.style.transform=`translateX(${dx}px)`; });
  row.addEventListener("touchend", ()=>{ if(dx<-80) row.style.transform=`translateX(-${SWIPE_WIDTH}px)`; else row.style.transform="translateX(0)"; dx=0; });

  const left=document.createElement("div"); left.className="task-left";
  const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=task.done;
  cb.onchange=e=>{ task.done=cb.checked; save(); render(); e.stopPropagation(); };
  left.append(cb);

  const mid=document.createElement("div"); mid.className="task-middle";
  const title=document.createElement("div"); title.className="task-title"; title.textContent=task.title;
  title.onclick=()=>openDetails(task.id); mid.append(title);

  const right=document.createElement("div"); right.className="task-right";
  const dot=document.createElement("div"); dot.className="dot";
  dot.style.background=task.priority===1?"#ff3b30":task.priority===2?"#ff9500":"#34c759";
  right.append(dot);

  row.append(left,mid,right); card.append(bg,row); tasksDiv.append(card);
}

// ===============================
// ADVANCED ADD SWIPE
// ===============================
let advStartY=0, advDragging=false;
adv.addEventListener("touchstart", e=>{ advStartY=e.touches[0].clientY; advDragging=true; adv.style.transition="none"; });
adv.addEventListener("touchmove", e=>{ if(!advDragging) return; const dy=e.touches[0].clientY-advStartY; if(dy>0) { e.preventDefault(); adv.style.transform=`translateY(${dy}px)`; }});
adv.addEventListener("touchend", e=>{ advDragging=false; adv.style.transition="transform 0.3s ease"; const dy=e.changedTouches[0].clientY-advStartY; if(dy>120) closeAdvancedAdd(); else adv.style.transform="translateY(0)"; });

// ===============================
// DETAILS SWIPE BACK
// ===============================
let detailsStartX=0, detailsStartY=0, detailsTracking=false;
detailsView.addEventListener("touchstart", e=>{ if(e.touches.length!==1) return; detailsStartX=e.touches[0].clientX; detailsStartY=e.touches[0].clientY; detailsTracking=true; });
detailsView.addEventListener("touchmove", e=>{ if(!detailsTracking) return; const dx=e.touches[0].clientX-detailsStartX; const dy=e.touches[0].clientY-detailsStartY; if(Math.abs(dx)>Math.abs(dy) && dx>0) e.preventDefault(); });
detailsView.addEventListener("touchend", e=>{ if(!detailsTracking) return; detailsTracking=false; const dx = e.changedTouches[0].clientX - detailsStartX; if(dx>80) closeDetails(); });

// ===============================
// ADVANCED ADD FUNCTIONS
// ===============================
function openAdvancedAdd(){ adv.style.transform="translateY(0)"; }
function closeAdvancedAdd(){ adv.style.transform="translateY(100%)"; }

// ===============================
// DETAILS FUNCTIONS
// ===============================
function openDetails(id){ active=tasks.find(t=>t.id===id); editMode=false; renderDetails(); detailsView.classList.remove("hidden"); }
function closeDetails(){ save(); render(); detailsView.classList.add("hidden"); }
function toggleEdit(){
  if(editMode){ 
    active.title=eTitle.value.trim(); 
    active.desc=eDesc.value.trim(); 
    active.scheduled=eDate.value; 
    active.edited=Date.now(); 
    save(); 
  }
  editMode=!editMode; editBtn.textContent=editMode?"Done":"Edit"; renderDetails();
}
function deleteTask(){ tasks=tasks.filter(t=>t.id!==active.id); save(); closeDetails(); }
function renderDetails(){
  vTitle.textContent=active.title; vDesc.textContent=active.desc; eTitle.value=active.title; eDesc.value=active.desc;
  eDate.value = active.scheduled || "";
  vDate.textContent = active.scheduled ? active.scheduled : "To Be Scheduled";
  secDesc.classList.toggle("hidden",!editMode&&!active.desc);
  secSubs.classList.toggle("hidden",!editMode&&active.subtasks.length===0);
  secDate.classList.remove("hidden");
  [vTitle,vDesc,vDate].forEach(e=>e.classList.toggle("hidden",editMode));
  [eTitle,eDesc,eDate,subInput,addSubBtn,deleteBtn].forEach(e=>e.classList.toggle("hidden",!editMode));
  subtasks.innerHTML = "";
  active.subtasks.forEach((s, i) => {
    const r = document.createElement("div");
    r.className = "subtask";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = s.done;
    cb.onchange = () => {
      s.done = cb.checked;
      active.done = active.subtasks.length>0 && active.subtasks.every(st=>st.done);
      active.edited = Date.now();
      save(); render(); renderDetails();
    };
    const text = document.createElement("div");
    text.className = "text"; text.textContent = s.title;
    r.append(cb, text); subtasks.append(r);
  });
  timestamps.textContent=`Created: ${new Date(active.created).toLocaleString()} ¬∑ Edited: ${new Date(active.edited).toLocaleString()}`;
}
function addSubtasks(){ active.desc=eDesc.value.trim(); active.edited=Date.now(); subInput.value.split("\n").filter(Boolean).forEach(t=>active.subtasks.push({title:t,done:false})); subInput.value=""; save(); renderDetails(); }
  render();
function setAgendaView(view){
  agendaView = view;
  render();
}


</script>
</body>
</html>
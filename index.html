<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Todo App ‚Äì v0.18</title>

<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkSystemFont, "SF Pro Text", sans-serif; background: #f2f2f7; }
.hidden { display: none; }

/* HEADER */
header {
  position: fixed; top: 0; left: 0; right: 0;
  height: 56px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px;
  z-index: 20;
}
header .title { font-size: 20px; font-weight: 700; }
header .version { font-size: 12px; color: #888; }
header button {
  padding: 8px 16px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: #f2f2f7;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
}
header button:active {
  background: #e5e5e5;
}

/* TAB BAR */
#tabBar {
  position: fixed; top: 56px; left: 0; right: 0;
  height: 44px;
  display: flex;
  background: #fff;
  border-bottom: 1px solid #ddd;
  z-index: 20;
}
.tab {
  flex: 1;
  text-align: center;
  line-height: 44px;
  cursor: pointer;
  font-weight: 600;
  color: #666;
  font-size: 15px;
}
.tab.active { color: #000; border-bottom: 2px solid #000; }

/* AGENDA VIEW TOGGLE */
#agendaToggle {
  position: fixed;
  top: 100px;
  left: 0;
  right: 0;
  padding: 10px 12px;
  display: none;
  background: #fff;
  border-bottom: 1px solid #ddd;
  z-index: 19;
}
#agendaToggle button {
  margin-right: 8px;
  padding: 10px 20px;
  border-radius: 12px;
  border: 1px solid #ccc;
  background: #f2f2f7;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  min-height: 44px;
}
#agendaToggle button.active {
  background: #000;
  color: #fff;
  border-color: #000;
}
#agendaToggle button:active {
  transform: scale(0.97);
}

/* CONTENT */
#content { 
  padding-top: 102px; 
  padding-bottom: 120px; 
  overflow-y: auto; 
  position: relative; 
}
#content.agenda-mode {
  padding-top: 156px;
}

/* TASK */
.task { background: #fff; margin: 10px 12px; border-radius: 16px; overflow: hidden; position: relative; }
.task.done { opacity: 0.45; }
.task-row { display: flex; align-items: center; min-height: 60px; padding: 0 16px; background: #fff; position: relative; z-index: 2; transition: transform 0.25s ease, opacity 0.25s ease; touch-action: pan-y; }
.task-left { width: 44px; display: flex; align-items: center; justify-content: center; }
.task-left input[type="checkbox"] {
  width: 24px;
  height: 24px;
  cursor: pointer;
}
.task-middle { flex: 1; min-width: 0; padding: 0 12px; }
.task-right { width: 32px; display: flex; align-items: center; justify-content: center; }
.task-title { font-size: 17px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; line-height: 1.4; }
.dot { width: 12px; height: 12px; border-radius: 50%; }

/* Alert indicator */
.alert-indicator {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 16px;
  z-index: 3;
}

/* SWIPE */
.swipe-bg { position: absolute; inset: 0; display: flex; justify-content: flex-end; align-items: center; padding-right: 8px; background: #f2f2f7; z-index: 1; }
.swipe-btn { 
  width: 50px; 
  height: 50px; 
  border-radius: 14px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  margin-left: 6px; 
  color: #fff; 
  font-size: 20px;
  cursor: pointer;
  flex-shrink: 0;
}

/* ADD BAR */
#addBar { 
  position: fixed; 
  bottom: 0; 
  left: 0; 
  right: 0; 
  background: #fff; 
  border-top: 1px solid #ddd; 
  padding: 12px; 
  display: flex; 
  gap: 10px; 
  z-index: 20; 
}
#addBar input, #addBar select { 
  flex: 1; 
  font-size: 17px; 
  padding: 14px; 
  border-radius: 12px; 
  border: 1px solid #ccc; 
  min-height: 48px;
}
#addBar button { 
  padding: 0 20px; 
  font-size: 24px; 
  border-radius: 12px; 
  border: none; 
  background: #000; 
  color: #fff; 
  min-width: 48px;
  min-height: 48px;
  cursor: pointer;
  font-weight: 600;
}
#addBar button:active {
  background: #333;
}

/* DETAILS */
#details { position: fixed; inset: 0; background: #f2f2f7; z-index: 50; overflow-y: auto; }
#details .spacer { height: 72px; }
.section { background: #fff; margin: 12px; padding: 16px; border-radius: 16px; }
.section h3 { margin: 0 0 10px; font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
.read { font-size: 17px; line-height: 1.5; }
input, textarea, select { 
  width: 100%; 
  font-size: 17px; 
  padding: 12px; 
  border-radius: 12px; 
  border: 1px solid #ccc; 
  font-family: -apple-system, BlinkSystemFont, "SF Pro Text", sans-serif;
}
input[type="date"], input[type="time"] { height: 48px; padding: 12px; }
textarea { resize: none; }

/* SUBTASK */
.subtask { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.subtask input { width: 22px; height: 22px; cursor: pointer; }
.subtask .text { flex: 1; font-size: 16px; }
#deleteBtn { 
  margin: 16px 12px; 
  padding: 16px; 
  font-size: 17px; 
  font-weight: 600;
  border-radius: 16px; 
  background: #ff3b30; 
  color: #fff; 
  border: none; 
  width: calc(100% - 24px);
  cursor: pointer;
  min-height: 52px;
}
#deleteBtn:active {
  background: #cc2e24;
}
.timestamps { margin: 0 12px 24px; font-size: 12px; color: #888; line-height: 1.6; }

/* ADVANCED ADD TASK PULL-UP - COMPACT VERSION */
#advAddTask {
  position: fixed; 
  left: 0; 
  right: 0; 
  bottom: 0;
  height: 85vh;
  max-height: 85vh;
  background: #fff;
  border-top-left-radius: 20px; 
  border-top-right-radius: 20px;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.15);
  transform: translateY(100%); 
  transition: transform 0.3s ease; 
  z-index: 30; 
  padding: 16px;
  touch-action: none;
  display: flex;
  flex-direction: column;
}
#advAddTask .handle { 
  width: 40px; 
  height: 4px; 
  background: #ccc; 
  border-radius: 2px; 
  margin: 0 auto 12px;
  flex-shrink: 0;
}
#advAddTask h3 { 
  margin: 0 0 12px; 
  font-size: 18px; 
  font-weight: 700;
  flex-shrink: 0;
}

/* Compact form container */
.adv-form-container {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 12px;
}

/* Advanced add form group - COMPACT */
.adv-form-group {
  margin-bottom: 8px;
}
.adv-form-group label {
  display: block;
  font-size: 11px;
  color: #666;
  margin-bottom: 4px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.adv-form-group input,
.adv-form-group textarea,
.adv-form-group select {
  width: 100%;
  font-size: 16px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-family: -apple-system, BlinkSystemFont, "SF Pro Text", sans-serif;
}
.adv-form-group textarea {
  resize: none;
}
.adv-form-group input[type="date"],
.adv-form-group input[type="time"] {
  height: 42px;
  padding: 10px;
}

/* Alert time fields - compact */
.alert-time-group {
  display: flex;
  gap: 6px;
}
.alert-time-group input {
  flex: 1;
}

/* Toggle switch - smaller */
.toggle-group {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
}
.toggle-group span {
  font-size: 15px;
}
.toggle-switch {
  position: relative;
  width: 48px;
  height: 28px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .3s;
  border-radius: 28px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 24px;
  width: 24px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}
input:checked + .toggle-slider {
  background-color: #34c759;
}
input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

/* Button container - fixed at bottom */
.adv-button-container {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding-top: 8px;
  border-top: 1px solid #eee;
}

#advAddTask button {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  min-height: 48px;
}
#advAddTask button:first-of-type {
  background: #000;
  color: #fff;
}
#advAddTask button:first-of-type:active {
  background: #333;
}
#advAddTask button:last-of-type {
  background: #f2f2f7;
  color: #000;
}
#advAddTask button:last-of-type:active {
  background: #e5e5e5;
}

/* Test alert button */
.test-alert-btn {
  background: #007aff !important;
  font-size: 14px !important;
  padding: 10px !important;
  min-height: 40px !important;
  margin-top: 4px;
}

/* AGENDA DATE HEADER */
.agenda-date { margin: 12px 12px 4px; font-weight: 700; font-size: 15px; color: #333; }

/* SCHEDULE SELECTOR */
#reschedulePopup {
  position: fixed; z-index: 60; background: #fff; border-radius: 16px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.25);
  padding: 16px; display: none; text-align: center;
  min-width: 280px;
}
#reschedulePopup > div:first-child {
  font-weight: 600;
  margin-bottom: 12px;
  font-size: 16px;
}
#reschedulePopup button { 
  margin: 6px; 
  padding: 10px 16px; 
  border-radius: 12px; 
  border: 1px solid #ccc; 
  background: #f2f2f7; 
  cursor: pointer; 
  font-size: 15px;
  font-weight: 600;
  min-height: 44px;
}
#reschedulePopup button:active {
  background: #e5e5e5;
}
#reschedulePopup input[type="date"] {
  margin: 6px;
  width: calc(100% - 12px);
}

/* CALENDAR */
.month-section {
  margin-bottom: 24px;
}
.month-header {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
  padding: 0 12px;
}

/* Week day headers */
.weekday-headers {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 8px;
  padding: 0 12px;
}
.weekday-header {
  text-align: center;
  font-size: 11px;
  font-weight: 700;
  color: #888;
  height: 24px;
  line-height: 24px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.month-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  padding: 0 12px;
}
.calendar-day {
  height: 48px;
  border-radius: 12px;
  background: #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  cursor: pointer;
  position: relative;
  font-size: 16px;
}
.calendar-day.empty {
  background: transparent;
  cursor: default;
}
.calendar-day.weekend {
  background: #f9f9f9;
}
.calendar-day.has-tasks {
  background: #ffd60a;
  color: #000;
}
.calendar-day.has-important {
  background: #ff9500;
  color: #fff;
}
.calendar-day.has-must {
  background: #ff3b30;
  color: #fff;
}
.calendar-day.today {
  box-shadow: 0 0 0 3px #000;
}
.calendar-day.today.empty {
  box-shadow: none;
}
.calendar-day:active:not(.empty) {
  transform: scale(0.95);
}

/* Task count badge */
.task-count {
  position: absolute;
  top: 3px;
  right: 3px;
  background: rgba(0,0,0,0.3);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 8px;
  min-width: 16px;
  text-align: center;
}

/* DAY LIST VIEW */
.day-header {
  background: #fff;
  margin: 12px;
  padding: 16px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  min-height: 60px;
}
.day-header:active {
  background: #f9f9f9;
}
.back-arrow {
  font-size: 24px;
  width: 32px;
  text-align: center;
}
.day-title {
  font-size: 20px;
  font-weight: 700;
  flex: 1;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #888;
}
.empty-state-icon {
  font-size: 56px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.empty-state-text {
  font-size: 17px;
  font-weight: 500;
}

/* Stats badge in agenda list */
.date-stats {
  display: inline-block;
  margin-left: 8px;
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 10px;
  background: #f0f0f0;
  color: #666;
  font-weight: 600;
}

/* Subtask controls in details */
#subInput {
  margin-top: 12px;
}
#addSubBtn {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  background: #f2f2f7;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
}
#addSubBtn:active {
  background: #e5e5e5;
}

/* Alert info display */
.alert-info {
  font-size: 15px;
  color: #555;
  margin-top: 4px;
}
</style>

</head>

<body>

<header>
  <div class="title">Todo App</div>
  <div class="version">v0.18</div>
</header>

<div id="tabBar">
  <div class="tab active" data-tab="today">Today</div>
  <div class="tab" data-tab="unscheduled">To Be Scheduled</div>
  <div class="tab" data-tab="agenda">Agenda</div>
</div>

<!-- AGENDA VIEW TOGGLE -->

<div id="agendaToggle">
  <button id="calendarBtn" class="active">Calendar</button>
  <button id="listBtn">List</button>
</div>

<div id="content"><div id="tasks"></div></div>

<div id="addBar">
  <input id="newTitle" placeholder="New task‚Ä¶" />
  <select id="newPriority">
    <option value="3">Normal</option>
    <option value="2">Important</option>
    <option value="1">Must</option>
  </select>
  <button onclick="addTask()">+</button>
  <button onclick="openAdvancedAdd()">‚ãÅ</button>
</div>

<!-- ADVANCED ADD TASK -->

<div id="advAddTask">
  <div class="handle"></div>
  <h3>Advanced Add Task</h3>

  <div class="adv-form-container">
    <div class="adv-form-group">
      <label>Title</label>
      <input id="advTitle" placeholder="Task title" />
    </div>

```
<div class="adv-form-group">
  <label>Description</label>
  <textarea id="advDesc" placeholder="Description" rows="2"></textarea>
</div>

<div class="adv-form-group">
  <label>Priority</label>
  <select id="advPriority">
    <option value="3">Normal</option>
    <option value="2">Important</option>
    <option value="1">Must</option>
  </select>
</div>

<div class="adv-form-group">
  <label>Subtasks</label>
  <textarea id="advSubtasks" placeholder="One per line" rows="2"></textarea>
</div>

<div class="adv-form-group">
  <label>Scheduled Date</label>
  <input type="date" id="advDate" />
</div>

<div class="adv-form-group">
  <label>Alert</label>
  <div class="toggle-group">
    <span>Enable alert</span>
    <label class="toggle-switch">
      <input type="checkbox" id="advAlertEnabled" onchange="toggleAlertFields()">
      <span class="toggle-slider"></span>
    </label>
  </div>
</div>

<div id="alertFields" class="hidden">
  <div class="adv-form-group">
    <label>Alert Date & Time</label>
    <div class="alert-time-group">
      <input type="date" id="advAlertDate" />
      <input type="time" id="advAlertTime" />
    </div>
  </div>
</div>
```

  </div>

  <div class="adv-button-container">
    <button onclick="addAdvancedTask()">Add Task</button>
    <button onclick="closeAdvancedAdd()">Cancel</button>
    <button class="test-alert-btn" onclick="testAlert()">üîî Test Alert (30 sec)</button>
  </div>
</div>

<!-- RESCHEDULE POPUP -->

<div id="reschedulePopup">
  <div>Select Date</div>
  <button onclick="rescheduleTask('tomorrow')">Tomorrow</button>
  <input type="date" id="rescheduleInput">
  <button onclick="applyReschedule()">Apply</button>
</div>

<!-- DETAILS -->

<div id="details" class="hidden">
  <header>
    <button onclick="closeDetails()">‚Üê Back</button>
    <button id="editBtn" onclick="toggleEdit()">Edit</button>
  </header>
  <div class="spacer"></div>
  <div class="section"><h3>Title</h3><div id="vTitle" class="read"></div><input id="eTitle" class="hidden"></div>
  <div class="section hidden" id="secDesc"><h3>Description</h3><div id="vDesc" class="read"></div><textarea id="eDesc" class="hidden" rows="3"></textarea></div>
  <div class="section hidden" id="secSubs"><h3>Subtasks</h3><div id="subtasks"></div><textarea id="subInput" class="hidden" placeholder="One subtask per line" rows="3"></textarea><button id="addSubBtn" class="hidden" onclick="addSubtasks()">+ Add Subtasks</button></div>
  <div class="section" id="secDate"><h3>Scheduled Date</h3><input type="date" id="eDate" class="hidden"><div id="vDate" class="read"></div></div>

  <div class="section" id="secAlert">
    <h3>Alert</h3>
    <div id="vAlert" class="read"></div>
    <div id="eAlert" class="hidden">
      <div class="toggle-group" style="margin-bottom: 12px;">
        <span>Enable alert</span>
        <label class="toggle-switch">
          <input type="checkbox" id="eAlertEnabled" onchange="toggleEditAlertFields()">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div id="editAlertFields" class="hidden">
        <div class="alert-time-group">
          <input type="date" id="eAlertDate" />
          <input type="time" id="eAlertTime" />
        </div>
      </div>
    </div>
  </div>

<button id="deleteBtn" class="hidden" onclick="deleteTask()">Delete Task</button>

  <div class="timestamps" id="timestamps"></div>
</div>

<script>
// Elements
const newTitle = document.getElementById("newTitle");
const newPriority = document.getElementById("newPriority");
const tasksDiv = document.getElementById("tasks");
const contentDiv = document.getElementById("content");
const adv = document.getElementById("advAddTask");
const advTitle = document.getElementById("advTitle");
const advDesc = document.getElementById("advDesc");
const advPriority = document.getElementById("advPriority");
const advSubtasks = document.getElementById("advSubtasks");
const advDate = document.getElementById("advDate");
const advAlertEnabled = document.getElementById("advAlertEnabled");
const advAlertDate = document.getElementById("advAlertDate");
const advAlertTime = document.getElementById("advAlertTime");
const alertFields = document.getElementById("alertFields");
const tabs = document.querySelectorAll(".tab");
const addBar = document.getElementById("addBar");
const detailsView = document.getElementById("details");
const resPopup = document.getElementById("reschedulePopup");
const resInput = document.getElementById("rescheduleInput");
const agendaToggle = document.getElementById("agendaToggle");
const calendarBtn = document.getElementById("calendarBtn");
const listBtn = document.getElementById("listBtn");

let tasks = JSON.parse(localStorage.getItem("tasks_v064") || "[]");
let active = null;
let editMode = false;
let currentTab = "today";
const SWIPE_WIDTH = 170;

// Local date formatting
function formatDateLocal(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function formatDateTimeLocal(date) {
  return formatDateLocal(date) + 'T' + date.toTimeString().slice(0, 5);
}

const todayStr = formatDateLocal(new Date());
advDate.value = "";

let agendaView = "calendar";
let selectedAgendaDate = null;

// ===============================
// TEST ALERT FUNCTION
// ===============================
function testAlert() {
  if ("Notification" in window) {
    if (Notification.permission === "granted") {
      const now = new Date();
      const alertTime = new Date(now.getTime() + 30000);
      
      const testTask = {
        id: Date.now(),
        title: "üîî Test Alert (will fire in 30 seconds)",
        desc: "This is a test alert to verify notifications work",
        priority: 2,
        done: false,
        subtasks: [],
        scheduled: todayStr,
        alert: {
          datetime: formatDateLocal(alertTime) + 'T' + alertTime.toTimeString().slice(0, 5),
          triggered: false
        },
        created: Date.now(),
        edited: Date.now()
      };
      
      tasks.push(testTask);
      save();
      closeAdvancedAdd();
      render();
      
      alert("‚úÖ Test alert created! It will notify you in 30 seconds.\n\nMake sure:\n1. Notifications are enabled\n2. Keep this tab open\n3. The app checks every minute");
      
    } else if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          testAlert();
        } else {
          alert("‚ùå Please enable notifications to test alerts");
        }
      });
    } else {
      alert("‚ùå Notifications are blocked. Please enable them in your browser settings.");
    }
  } else {
    alert("‚ùå This browser doesn't support notifications");
  }
}

// ===============================
// ALERT TOGGLE
// ===============================
function toggleAlertFields() {
  if (advAlertEnabled.checked) {
    alertFields.classList.remove("hidden");
    if (advDate.value) {
      advAlertDate.value = advDate.value;
      advAlertTime.value = "09:00";
    }
  } else {
    alertFields.classList.add("hidden");
  }
}

function toggleEditAlertFields() {
  const eAlertEnabled = document.getElementById("eAlertEnabled");
  const editAlertFields = document.getElementById("editAlertFields");
  if (eAlertEnabled.checked) {
    editAlertFields.classList.remove("hidden");
  } else {
    editAlertFields.classList.add("hidden");
  }
}

// ===============================
// VIEW TOGGLE BUTTONS
// ===============================
calendarBtn.addEventListener("click", () => {
  agendaView = "calendar";
  selectedAgendaDate = null;
  calendarBtn.classList.add("active");
  listBtn.classList.remove("active");
  render();
});

listBtn.addEventListener("click", () => {
  agendaView = "list";
  selectedAgendaDate = null;
  calendarBtn.classList.remove("active");
  listBtn.classList.add("active");
  render();
});

/* ===============================
   ADD BAR : SWIPE UP TO OPEN ADVANCED ADD
   =============================== */
let addStartY = 0;
let addDragging = false;

addBar.addEventListener("touchstart", e => {
  addStartY = e.touches[0].clientY;
  addDragging = true;
});

addBar.addEventListener("touchmove", e => {
  if (!addDragging) return;
  const dy = addStartY - e.touches[0].clientY;

  if (dy > 60) {
    openAdvancedAdd();
    addDragging = false;
  }
});

addBar.addEventListener("touchend", () => {
  addDragging = false;
});

// ===============================
// TAB SWITCH
// ===============================
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    currentTab = tab.dataset.tab;
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    render();
  });
});

// ===============================
// SAVE
// ===============================
function save() { 
  localStorage.setItem("tasks_v064", JSON.stringify(tasks)); 
}

// ===============================
// QUICK ADD
// ===============================
function addTask() {
  const t = newTitle.value.trim();
  if (!t) return;
  const now = Date.now();
  let scheduled = "";
  if (currentTab === "today") scheduled = todayStr;
  tasks.push({
    id: now, 
    title: t, 
    desc: "", 
    priority: +newPriority.value, 
    done: false, 
    subtasks: [], 
    scheduled, 
    alert: null,
    created: now, 
    edited: now
  });
  newTitle.value = "";
  save(); 
  render();
}

// ===============================
// ADVANCED ADD
// ===============================
function addAdvancedTask() {
  const t = advTitle.value.trim(); 
  if (!t) return;
  const now = Date.now();
  const subs = advSubtasks.value.split("\n").filter(Boolean).map(s => ({title: s, done: false}));
  
  let alert = null;
  if (advAlertEnabled.checked && advAlertDate.value && advAlertTime.value) {
    alert = {
      datetime: advAlertDate.value + 'T' + advAlertTime.value,
      triggered: false
    };
  }
  
  tasks.push({
    id: now, 
    title: t, 
    desc: advDesc.value.trim(), 
    priority: +advPriority.value, 
    done: false, 
    subtasks: subs, 
    scheduled: advDate.value || "", 
    alert: alert,
    created: now, 
    edited: now
  });
  
  advTitle.value = ""; 
  advDesc.value = ""; 
  advSubtasks.value = ""; 
  advPriority.value = 3; 
  advDate.value = "";
  advAlertEnabled.checked = false;
  advAlertDate.value = "";
  advAlertTime.value = "";
  alertFields.classList.add("hidden");
  
  save(); 
  render(); 
  closeAdvancedAdd();
}

// ===============================
// SWIPE BUTTON HELPER
// ===============================
function swipeBtn(icon, color, fn) { 
  const b = document.createElement("div"); 
  b.className = "swipe-btn"; 
  b.textContent = icon; 
  b.style.background = color; 
  b.onclick = e => { 
    e.stopPropagation(); 
    fn(); 
  }; 
  return b; 
}

// ===============================
// RESCHEDULE
// ===============================
let currentResTask = null;

function openReschedule(task, row) {
  currentResTask = task;
  resPopup.style.display = "block";
  const rect = row.getBoundingClientRect();
  resPopup.style.top = (rect.top + rect.height / 2 - 80) + "px";
  resPopup.style.left = (window.innerWidth / 2 - 140) + "px";
}

function rescheduleTask(option) {
  if (option === "tomorrow") {
    const d = new Date();
    d.setDate(d.getDate() + 1);
    currentResTask.scheduled = formatDateLocal(d);
  }
  save(); 
  render(); 
  hideResPopup();
}

function applyReschedule() {
  if (!currentResTask) return;
  currentResTask.scheduled = resInput.value || "";
  save();
  render();
  hideResPopup();
}

function hideResPopup() { 
  resPopup.style.display = "none"; 
  currentResTask = null; 
}

document.addEventListener("click", e => { 
  if (!resPopup.contains(e.target)) hideResPopup(); 
});

// ===============================
// RENDER TASKS
// ===============================
function render() {
  tasksDiv.innerHTML = "";

  if (currentTab !== "agenda") {
    agendaToggle.style.display = "none";
    contentDiv.classList.remove("agenda-mode");
    
    const filtered = tasks.filter(t => currentTab === "today"
      ? t.scheduled === todayStr
      : !t.scheduled);
    
    if (filtered.length === 0) {
      const empty = document.createElement("div");
      empty.className = "empty-state";
      empty.innerHTML = `
        <div class="empty-state-icon">${currentTab === "today" ? "‚úì" : "üìã"}</div>
        <div class="empty-state-text">${currentTab === "today" ? "No tasks for today" : "No unscheduled tasks"}</div>
      `;
      tasksDiv.appendChild(empty);
    } else {
      filtered.forEach(renderTaskCard);
    }
    return;
  }

  agendaToggle.style.display = "block";
  contentDiv.classList.add("agenda-mode");

  if (agendaView === "calendar") {
    renderCalendar();
    return;
  }

  if (agendaView === "list") {
    renderAgendaList();
    return;
  }

  if (agendaView === "dayList") {
    renderDayList();
    return;
  }
}

// ===============================
// RENDER CALENDAR
// ===============================
function renderCalendar() {
  const today = new Date();
  const todayDateStr = formatDateLocal(today);
  const monthsToShow = 4;

  for (let m = 0; m < monthsToShow; m++) {
    const monthDate = new Date(today.getFullYear(), today.getMonth() + m, 1);
    const year = monthDate.getFullYear();
    const month = monthDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    
    const firstDayMonday = firstDay === 0 ? 6 : firstDay - 1;

    const monthSection = document.createElement("div");
    monthSection.className = "month-section";

    const monthHeader = document.createElement("div");
    monthHeader.className = "month-header";
    monthHeader.textContent = monthDate.toLocaleString('default', { 
      month: 'long', 
      year: 'numeric' 
    });
    monthSection.appendChild(monthHeader);

    const weekdayHeaders = document.createElement("div");
    weekdayHeaders.className = "weekday-headers";
    const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    weekdays.forEach(day => {
      const header = document.createElement("div");
      header.className = "weekday-header";
      header.textContent = day;
      weekdayHeaders.appendChild(header);
    });
    monthSection.appendChild(weekdayHeaders);

    const monthGrid = document.createElement("div");
    monthGrid.className = "month-grid";

    for (let i = 0; i < firstDayMonday; i++) {
      const empty = document.createElement("div");
      empty.className = "calendar-day empty";
      monthGrid.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dayDate = new Date(year, month, day);
      const dateStr = formatDateLocal(dayDate);
      const dayTasks = tasks.filter(t => t.scheduled === dateStr);
      const dayOfWeek = dayDate.getDay();

      const cell = document.createElement("div");
      cell.className = "calendar-day";
      cell.textContent = day;

      if (dayOfWeek === 0 || dayOfWeek === 6) {
        cell.classList.add("weekend");
      }

      if (dateStr === todayDateStr) {
        cell.classList.add("today");
      }

      if (dayTasks.length > 0) {
        const hasMust = dayTasks.some(t => t.priority === 1);
        const hasImportant = dayTasks.some(t => t.priority === 2);

        if (hasMust) {
          cell.classList.add("has-must");
        } else if (hasImportant) {
          cell.classList.add("has-important");
        } else {
          cell.classList.add("has-tasks");
        }

        if (dayTasks.length > 1) {
          const badge = document.createElement("span");
          badge.className = "task-count";
          badge.textContent = dayTasks.length;
          cell.appendChild(badge);
        }
      }

      cell.onclick = () => {
        if (dayTasks.length > 0) {
          selectedAgendaDate = dateStr;
          agendaView = "dayList";
          render();
        }
      };

      monthGrid.appendChild(cell);
    }

    monthSection.appendChild(monthGrid);
    tasksDiv.appendChild(monthSection);
  }
}

function renderAgendaList() {
  const tasksByDate = {};
  tasks
    .filter(t => t.scheduled)
    .forEach(t => {
      if (!tasksByDate[t.scheduled]) {
        tasksByDate[t.scheduled] = [];
      }
      tasksByDate[t.scheduled].push(t);
    });

  const sortedDates = Object.keys(tasksByDate).sort();

  sortedDates.forEach(dateStr => {
    const dayTasks = tasksByDate[dateStr];
    const completedCount = dayTasks.filter(t => t.done).length;
    
    const header = document.createElement("div");
    header.className = "agenda-date";
    const date = new Date(dateStr + "T00:00:00");
    header.innerHTML = `
      ${date.toLocaleDateString('default', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      })}
      <span class="date-stats">${completedCount}/${dayTasks.length}</span>
    `;
    tasksDiv.appendChild(header);

    dayTasks.forEach(renderTaskCard);
  });

  if (sortedDates.length === 0) {
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.innerHTML = `
      <div class="empty-state-icon">üìÖ</div>
      <div class="empty-state-text">No scheduled tasks</div>
    `;
    tasksDiv.appendChild(empty);
  }
}

function renderDayList() {
  const header = document.createElement("div");
  header.className = "day-header";
  
  const arrow = document.createElement("span");
  arrow.className = "back-arrow";
  arrow.textContent = "‚Üê";
  
  const title = document.createElement("div");
  title.className = "day-title";
  const date = new Date(selectedAgendaDate + "T00:00:00");
  title.textContent = date.toLocaleDateString('default', { 
    weekday: 'long', 
    month: 'long', 
    day: 'numeric',
    year: 'numeric'
  });
  
  header.appendChild(arrow);
  header.appendChild(title);
  header.onclick = () => {
    selectedAgendaDate = null;
    agendaView = "calendar";
    render();
  };
  
  tasksDiv.appendChild(header);

  const dayTasks = tasks.filter(t => t.scheduled === selectedAgendaDate);
  
  if (dayTasks.length === 0) {
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.innerHTML = `
      <div class="empty-state-icon">‚úì</div>
      <div class="empty-state-text">No tasks for this day</div>
    `;
    tasksDiv.appendChild(empty);
  } else {
    dayTasks.forEach(renderTaskCard);
  }
}

function renderTaskCard(task) {
  const card = document.createElement("div");
  card.className = "task" + (task.done ? " done" : "");
  
  const bg = document.createElement("div"); 
  bg.className = "swipe-bg";
  bg.append(
    swipeBtn("‚úèÔ∏è", "#007aff", () => openDetails(task.id)),
    swipeBtn("üìÖ", "#ff9500", () => {
      const row = card.querySelector(".task-row");
      openReschedule(task, row);
    }),
    swipeBtn("üóë", "#ff3b30", () => { 
      tasks = tasks.filter(t => t.id !== task.id); 
      save(); 
      render(); 
    })
  );

  const row = document.createElement("div"); 
  row.className = "task-row";
  
  let startX = 0, dx = 0;
  row.addEventListener("touchstart", e => startX = e.touches[0].clientX);
  row.addEventListener("touchmove", e => { 
    dx = e.touches[0].clientX - startX; 
    if (dx < 0) row.style.transform = `translateX(${dx}px)`; 
  });
  row.addEventListener("touchend", () => { 
    if (dx < -80) row.style.transform = `translateX(-${SWIPE_WIDTH}px)`; 
    else row.style.transform = "translateX(0)"; 
    dx = 0; 
  });

  const left = document.createElement("div"); 
  left.className = "task-left";
  const cb = document.createElement("input"); 
  cb.type = "checkbox"; 
  cb.checked = task.done;
  cb.onchange = e => { 
    task.done = cb.checked; 
    save(); 
    render(); 
    e.stopPropagation(); 
  };
  left.append(cb);

  const mid = document.createElement("div"); 
  mid.className = "task-middle";
  const title = document.createElement("div"); 
  title.className = "task-title"; 
  title.textContent = task.title;
  title.onclick = () => openDetails(task.id); 
  mid.append(title);

  const right = document.createElement("div"); 
  right.className = "task-right";
  const dot = document.createElement("div"); 
  dot.className = "dot";
  dot.style.background = task.priority === 1 ? "#ff3b30" : task.priority === 2 ? "#ff9500" : "#ffd60a";
  right.append(dot);

  if (task.alert && !task.alert.triggered) {
    const alertIcon = document.createElement("div");
    alertIcon.className = "alert-indicator";
    alertIcon.textContent = "üîî";
    row.appendChild(alertIcon);
  }

  row.append(left, mid, right); 
  card.append(bg, row); 
  tasksDiv.append(card);
}

// ===============================
// ADVANCED ADD SWIPE
// ===============================
let advStartY = 0, advDragging = false;
adv.addEventListener("touchstart", e => { 
  advStartY = e.touches[0].clientY; 
  advDragging = true; 
  adv.style.transition = "none"; 
});
adv.addEventListener("touchmove", e => { 
  if (!advDragging) return; 
  const dy = e.touches[0].clientY - advStartY; 
  if (dy > 0) { 
    e.preventDefault(); 
    adv.style.transform = `translateY(${dy}px)`; 
  }
});
adv.addEventListener("touchend", e => { 
  advDragging = false; 
  adv.style.transition = "transform 0.3s ease"; 
  const dy = e.changedTouches[0].clientY - advStartY; 
  if (dy > 120) closeAdvancedAdd(); 
  else adv.style.transform = "translateY(0)"; 
});

// ===============================
// DETAILS SWIPE BACK
// ===============================
let detailsStartX = 0, detailsStartY = 0, detailsTracking = false;
detailsView.addEventListener("touchstart", e => { 
  if (e.touches.length !== 1) return; 
  detailsStartX = e.touches[0].clientX; 
  detailsStartY = e.touches[0].clientY; 
  detailsTracking = true; 
});
detailsView.addEventListener("touchmove", e => { 
  if (!detailsTracking) return; 
  const dx = e.touches[0].clientX - detailsStartX; 
  const dy = e.touches[0].clientY - detailsStartY; 
  if (Math.abs(dx) > Math.abs(dy) && dx > 0) e.preventDefault(); 
});
detailsView.addEventListener("touchend", e => { 
  if (!detailsTracking) return; 
  detailsTracking = false; 
  const dx = e.changedTouches[0].clientX - detailsStartX; 
  if (dx > 80) closeDetails(); 
});

// ===============================
// ADVANCED ADD FUNCTIONS
// ===============================
function openAdvancedAdd() { 
  adv.style.transform = "translateY(0)"; 
}

function closeAdvancedAdd() { 
  adv.style.transform = "translateY(100%)"; 
}

// ===============================
// DETAILS FUNCTIONS
// ===============================
function openDetails(id) { 
  active = tasks.find(t => t.id === id); 
  editMode = false; 
  renderDetails(); 
  detailsView.classList.remove("hidden"); 
}

function closeDetails() { 
  save(); 
  render(); 
  detailsView.classList.add("hidden"); 
}

function toggleEdit() {
  if (editMode) { 
    active.title = eTitle.value.trim(); 
    active.desc = eDesc.value.trim(); 
    active.scheduled = eDate.value;
    
    const eAlertEnabled = document.getElementById("eAlertEnabled");
    const eAlertDate = document.getElementById("eAlertDate");
    const eAlertTime = document.getElementById("eAlertTime");
    
    if (eAlertEnabled.checked && eAlertDate.value && eAlertTime.value) {
      active.alert = {
        datetime: eAlertDate.value + 'T' + eAlertTime.value,
        triggered: active.alert ? active.alert.triggered : false
      };
    } else {
      active.alert = null;
    }
    
    active.edited = Date.now(); 
    save(); 
  }
  editMode = !editMode; 
  editBtn.textContent = editMode ? "Done" : "Edit"; 
  renderDetails();
}

function deleteTask() { 
  tasks = tasks.filter(t => t.id !== active.id); 
  save(); 
  closeDetails(); 
}

function renderDetails() {
  vTitle.textContent = active.title; 
  vDesc.textContent = active.desc; 
  eTitle.value = active.title; 
  eDesc.value = active.desc;
  eDate.value = active.scheduled || "";
  vDate.textContent = active.scheduled ? active.scheduled : "To Be Scheduled";
  
  const vAlert = document.getElementById("vAlert");
  const eAlert = document.getElementById("eAlert");
  const eAlertEnabled = document.getElementById("eAlertEnabled");
  const eAlertDate = document.getElementById("eAlertDate");
  const eAlertTime = document.getElementById("eAlertTime");
  const editAlertFields = document.getElementById("editAlertFields");
  
  if (active.alert) {
    const alertDate = new Date(active.alert.datetime);
    vAlert.innerHTML = `üîî ${alertDate.toLocaleString('default', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })}${active.alert.triggered ? ' <span style="color: #888;">(triggered)</span>' : ''}`;
    
    eAlertEnabled.checked = true;
    eAlertDate.value = active.alert.datetime.split('T')[0];
    eAlertTime.value = active.alert.datetime.split('T')[1];
    editAlertFields.classList.remove("hidden");
  } else {
    vAlert.textContent = "No alert set";
    eAlertEnabled.checked = false;
    eAlertDate.value = "";
    eAlertTime.value = "";
    editAlertFields.classList.add("hidden");
  }
  
  secDesc.classList.toggle("hidden", !editMode && !active.desc);
  secSubs.classList.toggle("hidden", !editMode && active.subtasks.length === 0);
  secDate.classList.remove("hidden");
  
  [vTitle, vDesc, vDate, vAlert].forEach(e => e.classList.toggle("hidden", editMode));
  [eTitle, eDesc, eDate, eAlert, subInput, addSubBtn, deleteBtn].forEach(e => e.classList.toggle("hidden", !editMode));
  
  subtasks.innerHTML = "";
  active.subtasks.forEach((s, i) => {
    const r = document.createElement("div");
    r.className = "subtask";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = s.done;
    cb.onchange = () => {
      s.done = cb.checked;
      active.done = active.subtasks.length > 0 && active.subtasks.every(st => st.done);
      active.edited = Date.now();
      save(); 
      render(); 
      renderDetails();
    };
    const text = document.createElement("div");
    text.className = "text"; 
    text.textContent = s.title;
    r.append(cb, text); 
    subtasks.append(r);
  });
  
  timestamps.textContent = `Created: ${new Date(active.created).toLocaleString()}\nEdited: ${new Date(active.edited).toLocaleString()}`;
}

function addSubtasks() { 
  active.desc = eDesc.value.trim(); 
  active.edited = Date.now(); 
  subInput.value.split("\n").filter(Boolean).forEach(t => active.subtasks.push({title: t, done: false})); 
  subInput.value = ""; 
  save(); 
  renderDetails(); 
}

// ===============================
// CHECK ALERTS
// ===============================
function checkAlerts() {
  const now = new Date();
  let hasTriggered = false;
  
  tasks.forEach(task => {
    if (task.alert && !task.alert.triggered && !task.done) {
      const alertTime = new Date(task.alert.datetime);
      if (now >= alertTime) {
        task.alert.triggered = true;
        hasTriggered = true;
        
        console.log("üîî Alert triggered for:", task.title);
        
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("Task Reminder", {
            body: task.title,
            icon: "üîî",
            badge: "üîî"
          });
        } else {
          alert(`üîî Reminder: ${task.title}`);
        }
      }
    }
  });
  
  if (hasTriggered) {
    save();
    render();
  }
}

// Request notification permission
if ("Notification" in window && Notification.permission === "default") {
  Notification.requestPermission().then(permission => {
    console.log("Notification permission:", permission);
  });
}

// Check alerts every minute
setInterval(checkAlerts, 60000);
checkAlerts();

console.log("‚úÖ Alert system initialized. Checking every 60 seconds.");

render();
</script>

</body>
</html>
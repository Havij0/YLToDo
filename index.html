<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Todo App – v0.11</title>

<style>
/* ... (Your existing styles remain) ... */
* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkSystemFont, "SF Pro Text", sans-serif; background: #f2f2f7; }
.hidden { display: none; }

/* HEADER & TABS */
header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 20; }
header .title { font-size: 20px; font-weight: 700; }
header .version { font-size: 12px; color: #888; }
#tabBar { position: fixed; top: 56px; left: 0; right: 0; height: 44px; display: flex; background: #fff; border-bottom: 1px solid #ddd; z-index: 20; }
.tab { flex: 1; text-align: center; line-height: 44px; cursor: pointer; font-weight: 600; color: #666; }
.tab.active { color: #000; border-bottom: 2px solid #000; }

/* NEW AGENDA STYLES */
#agendaToggle { padding: 10px; display: flex; gap: 10px; justify-content: center; background: #f2f2f7; }
#agendaToggle button { padding: 6px 16px; border-radius: 20px; border: 1px solid #ccc; background: #fff; font-weight: 600; }
#agendaToggle button.active { background: #000; color: #fff; border-color: #000; }

.month-container { margin-bottom: 24px; }
.month-header { padding: 8px 16px; font-weight: 700; color: #555; text-transform: uppercase; font-size: 14px; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 0 12px; }
.calendar-day { height: 44px; border-radius: 12px; background: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; border: 1px solid #eee; }
.cal-yellow { background:#ffd60a; }
.cal-orange { background:#ff9f0a; }
.cal-red { background:#ff3b30; color:#fff; }

/* REST OF THE STYLES */
#content { padding-top: 102px; padding-bottom: 120px; overflow-y: auto; }
.task { background: #fff; margin: 10px 12px; border-radius: 16px; overflow: hidden; position: relative; }
.task.done { opacity: 0.45; }
.task-row { display: flex; align-items: center; min-height: 52px; padding: 0 14px; background: #fff; position: relative; z-index: 2; transition: transform 0.25s ease; touch-action: pan-y; }
.task-title { font-size: 16px; font-weight: 600; flex: 1; }
.dot { width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; }
.swipe-bg { position: absolute; inset: 0; display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; background: #f2f2f7; z-index: 1; }
.swipe-btn { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-left: 8px; color: #fff; }
#addBar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #ddd; padding: 10px 12px; display: flex; gap: 8px; z-index: 20; }
#addBar input { flex: 1; font-size: 16px; padding: 12px; border-radius: 14px; border: 1px solid #ccc; }
#details { position: fixed; inset: 0; background: #f2f2f7; z-index: 50; overflow-y: auto; }
.section { background: #fff; margin: 12px; padding: 12px 16px; border-radius: 16px; }
#advAddTask { position: fixed; left: 0; right: 0; bottom: 0; max-height: 90%; background: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; transform: translateY(100%); transition: transform 0.3s ease; z-index: 30; padding: 16px; }
</style>
</head>

<body>

<header>
  <div class="title">Todo App</div>
  <div class="version">v0.11</div>
</header>

<div id="tabBar">
  <div class="tab active" data-tab="today">Today</div>
  <div class="tab" data-tab="unscheduled">Inbox</div>
  <div class="tab" data-tab="agenda">Agenda</div>
</div>

<div id="content">
  <div id="agendaUI" class="hidden">
    <div id="agendaToggle">
      <button id="btnCal" onclick="setAgendaViewMode('calendar')" class="active">Calendar</button>
      <button id="btnList" onclick="setAgendaViewMode('list')">List</button>
    </div>
  </div>
  <div id="tasks"></div>
</div>

<div id="addBar">
  <input id="newTitle" placeholder="New task…" />
  <button onclick="addTask()">+</button>
  <button onclick="openAdvancedAdd()">⋁</button>
</div>

<div id="advAddTask">...</div>
<div id="details" class="hidden">...</div>

<script>
let tasks = JSON.parse(localStorage.getItem("tasks_v064") || "[]");
let currentTab = "today";
let agendaViewMode = "calendar"; 
let selectedAgendaDate = null;

// --- UTILITIES ---
function formatDateLocal(d) {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

const todayStr = formatDateLocal(new Date());

function save() { localStorage.setItem("tasks_v064", JSON.stringify(tasks)); }

// --- NAVIGATION ---
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    currentTab = tab.dataset.tab;
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    selectedAgendaDate = null; // Reset when switching tabs
    render();
  });
});

function setAgendaViewMode(mode) {
  agendaViewMode = mode;
  selectedAgendaDate = null;
  render();
}

// --- RENDERING ---
function render() {
  const tasksDiv = document.getElementById("tasks");
  const agendaUI = document.getElementById("agendaUI");
  tasksDiv.innerHTML = "";
  
  // Toggle Agenda Controls
  agendaUI.classList.toggle("hidden", currentTab !== "agenda");

  if (currentTab === "today") {
    const todayTasks = tasks.filter(t => t.scheduled === todayStr);
    todayTasks.forEach(t => renderTaskCard(t, tasksDiv));
  } 
  else if (currentTab === "unscheduled") {
    const inbox = tasks.filter(t => !t.scheduled);
    inbox.forEach(t => renderTaskCard(t, tasksDiv));
  } 
  else if (currentTab === "agenda") {
    renderAgendaLogic(tasksDiv);
  }
}

function renderAgendaLogic(container) {
  // Update button states
  document.getElementById("btnCal").classList.toggle("active", agendaViewMode === "calendar");
  document.getElementById("btnList").classList.toggle("active", agendaViewMode === "list");

  if (selectedAgendaDate) {
    renderDayList(container);
  } else if (agendaViewMode === "calendar") {
    renderCalendar(container);
  } else {
    renderAgendaList(container);
  }
}

function renderCalendar(container) {
  const today = new Date();
  for (let m = 0; m < 4; m++) {
    const monthDate = new Date(today.getFullYear(), today.getMonth() + m, 1);
    const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    
    const monthWrapper = document.createElement("div");
    monthWrapper.className = "month-container";
    monthWrapper.innerHTML = `<div class="month-header">${monthName}</div>`;
    
    const grid = document.createElement("div");
    grid.className = "calendar-grid";
    
    const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
    
    for (let i = 1; i <= daysInMonth; i++) {
      const currentLoopDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), i);
      const dateKey = formatDateLocal(currentLoopDate);
      const dayTasks = tasks.filter(t => t.scheduled === dateKey);
      
      const dayEl = document.createElement("div");
      dayEl.className = "calendar-day";
      dayEl.textContent = i;
      
      if (dayTasks.length > 0) {
        if (dayTasks.some(t => t.priority === 1)) dayEl.classList.add("cal-red");
        else if (dayTasks.some(t => t.priority === 2)) dayEl.classList.add("cal-orange");
        else dayEl.classList.add("cal-yellow");
      }
      
      dayEl.onclick = () => {
        selectedAgendaDate = dateKey;
        render();
      };
      grid.appendChild(dayEl);
    }
    monthWrapper.appendChild(grid);
    container.appendChild(monthWrapper);
  }
}

function renderDayList(container) {
  const dayTasks = tasks.filter(t => t.scheduled === selectedAgendaDate);
  const backBtn = document.createElement("div");
  backBtn.style = "padding: 12px; color: #007aff; cursor: pointer; font-weight: 600;";
  backBtn.textContent = "← Back to Calendar";
  backBtn.onclick = () => { selectedAgendaDate = null; render(); };
  
  const title = document.createElement("div");
  title.className = "month-header";
  title.textContent = "Tasks for " + selectedAgendaDate;
  
  container.append(backBtn, title);
  dayTasks.forEach(t => renderTaskCard(t, container));
}

function renderAgendaList(container) {
  // Groups all scheduled tasks by date
  const scheduledTasks = tasks.filter(t => t.scheduled).sort((a,b) => a.scheduled.localeCompare(b.scheduled));
  let lastDate = "";
  
  scheduledTasks.forEach(t => {
    if (t.scheduled !== lastDate) {
      const h = document.createElement("div");
      h.className = "agenda-date";
      h.style = "margin: 16px 12px 4px; font-weight: 700; font-size: 13px; color: #888;";
      h.textContent = t.scheduled === todayStr ? "TODAY" : t.scheduled;
      container.appendChild(h);
      lastDate = t.scheduled;
    }
    renderTaskCard(t, container);
  });
}

// --- TASK CARD RENDERER (Simplified version of your code) ---
function renderTaskCard(task, container) {
  const card = document.createElement("div");
  card.className = "task" + (task.done ? " done" : "");
  card.innerHTML = `
    <div class="task-row">
      <input type="checkbox" ${task.done ? "checked" : ""} onclick="toggleTask(${task.id})">
      <div class="task-title">${task.title}</div>
      <div class="dot" style="background:${task.priority === 1 ? '#ff3b30' : task.priority === 2 ? '#ff9500' : '#34c759'}"></div>
    </div>
  `;
  container.appendChild(card);
}

function toggleTask(id) {
  const t = tasks.find(x => x.id === id);
  if (t) { t.done = !t.done; save(); render(); }
}

// Initial Run
render();
</script>
</body>
</html>
